<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Job Seeker Profile</title>
    <style>
        /* Basic Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #c3bcbc;
            color: #161718;
        }

        .logo {
            height: 50px; /* Adjust height as needed */
            width: auto; /* Maintain aspect ratio */
        }

        /* Navigation Bar */
        /* Header Styles */
        header {
            position: static;
            width:100%;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            text-align: left;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            margin: 0;
            font-size: 2em;
            font-weight: bold;
        }

        header nav {
            margin: 0;
        }

        header nav a {
            color: white;
            margin: 0 15px;
            text-decoration: none;
            font-size: 1.2em;
            position: relative;
            transition: color 0.3s ease;
        }

        header nav a:hover {
            color: #007bff;
        }

        header nav a::after {
            content: '';
            position: absolute;
            width: 0%;
            height: 2px;
            bottom: -5px;
            left: 50%;
            background-color: #007bff;
            transition: all 0.3s ease-in-out;
        }

        header nav a:hover::after {
            width: 100%;
            left: 0;
        }


        .profile-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 30px;
            margin-top: 80px; /* Adjusted to avoid overlap with fixed header */
        }

        .profile-card {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
        }

        .profile-header {
            display: flex;
            align-items: center;
        }

        .profile-picture {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 20px;
        }

        .profile-picture img {
            width: 100%;
            height: auto;
        }

        .profile-details {
            font-size: 1.2em;
        }

        form {
            margin-top: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        form label {
            font-weight: bold;
            display: block;
            margin: 5px 0;
        }

        form input, form select, form button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        form button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            width: auto;
            padding: 10px 20px;
        }

        form button:hover {
            background-color: #0056b3;
        }

        footer {
            text-align: center;
            padding: 20px 0;
            background: #333;
            color: #fff;
            margin-top: 40px;
        }

        /* Style for messages icon */
        .messages-link {

            position: relative;
            display: inline-block;
        }

        .messages-icon {
            padding-top: 5px;
            height: 25px; /* Adjust the icon size */
            width: auto;
        }

        .unread-count {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #ff0000; /* Red background for the unread count */
            color: white;
            border-radius: 50%;
            padding: 5px 10px;
            font-size: 0.6em;
            display: none; /* Initially hidden */
        }
    </style>
</head>
<body>
<header>
    <a href="/">
        <img src="images/logo.png" alt="JobMagnet Logo" class="logo">
    </a>
    <nav>
        <a href="/SeekerHomeLogged.html">HOME</a>
        <a href="/SeekerProfileNew.html">PROFILE</a>
        <a href="/Companies.html">COMPANIES</a>
        <a href="/ContactUs1.html">CONTACT</a>
        <!-- Messages icon with unread count -->
        <a href="/seeker/seekerUnreadMessages.html" class="messages-link">
            <img src="images/message.png" alt="Messages" class="messages-icon">
            <span id="unreadCount" class="unread-count"></span>
        </a>
    </nav>
</header>


<div class="profile-container">
    <div class="profile-card">
        <div class="profile-header">
            <div class="profile-picture">
                <img id="profilePicture" src="default-profile.jpg" alt="Profile Picture" />
            </div>
            <div class="profile-details">
                <h2>Edit profile</h2>
                <p id="email"></p>
            </div>
        </div>

        <form id="updateProfileForm" enctype="multipart/form-data">
            <div class="form-grid">
                <div>
                    <label for="fname">First Name</label>
                    <input type="text" id="fname" name="fname" placeholder="John" required>

                    <label for="dob">Date of Birth</label>
                    <input type="date" id="dob" name="dob" placeholder="Date of Birth">

                    <label for="skills">Skills</label>
                    <input type="text" id="skills" name="skills" placeholder="java,c#...">

                    <label for="phone">Mobile Number</label>
                    <input type="text" id="phone" name="phone" placeholder="07x-xxxxxxx">

                    <label for="bio">Bio</label>
                    <input type="text" id="bio" name="bio" placeholder="Bio">

                    <label for="university">University</label>
                    <input type="text" id="university" name="university" placeholder="University of peradeniya">

                    <label for="dclass">Class</label>
                    <input type="text" id="dclass" name="dclass" placeholder="second upper">
                </div>

                <div>
                    <label for="lname">Last Name</label>
                    <input type="text" id="lname" name="lname" placeholder="Doe" required>

                    <label for="password">New Password</label>
                    <input type="password" id="password" name="password" placeholder="New Password">

                    <label for="experience">Experience</label>
                    <input type="text" id="experience" name="experience" placeholder="2 years">

                    <label for="about">About</label>
                    <input type="text" id="about" name="about" placeholder="About">

                    <label for="degree">Degree</label>
                    <input type="text" id="degree" name="degree" placeholder="computer engineering">

                    <label for="projects">Projects</label>
                    <input type="text" id="projects" name="projects" placeholder="Projects">
                </div>
            </div>

            <label for="profilePictureInput">Upload Profile Picture (Optional)</label>
            <input type="file" id="profilePictureInput" name="profilePicture" accept="image/*">

            <button type="submit">Update Profile</button>
        </form>
    </div>
</div>


<footer>2024 JobMagnet. All rights reserved.</footer>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const recipientEmail = localStorage.getItem('email');
        if (recipientEmail) {
            try {
                const response = await fetch(`/api/messages/unread/${recipientEmail}`);
                const unreadMessages = await response.json();

                const unreadCount = unreadMessages.length;
                const unreadCountElement = document.getElementById('unreadCount');

                if (unreadCount > 0) {
                    unreadCountElement.textContent = unreadCount;
                    unreadCountElement.style.display = 'inline-block'; // Show the unread count if there are unread messages
                } else {
                    unreadCountElement.style.display = 'none'; // Hide if no unread messages
                }
            } catch (err) {
                console.error('Error fetching unread messages:', err);
            }
        }
    });

    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM fully loaded and parsed');

        const email = localStorage.getItem('email');
        console.log('Retrieved email from localStorage:', email);
        document.getElementById('email').innerText = email;

        // Fetch job seeker profile by email
        fetch(`/api/jobseekers/profile?email=${encodeURIComponent(email)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Fetched profile data:', data);
                document.querySelector('input[name="fname"]').value = data.fname;
                document.querySelector('input[name="lname"]').value = data.lname;
                document.querySelector('input[name="dob"]').value = data.dob;
                document.querySelector('input[name="skills"]').value = data.skills;
                document.querySelector('input[name="experience"]').value = data.experience;
                document.querySelector('input[name="phone"]').value = data.phone;
                document.querySelector('input[name="bio"]').value = data.bio;
                document.querySelector('input[name="about"]').value = data.about;
                document.querySelector('input[name="university"]').value = data.university;
                document.querySelector('input[name="degree"]').value = data.degree;
                document.querySelector('input[name="dclass"]').value = data.dclass;
                document.querySelector('input[name="projects"]').value = data.projects;

                const profilePicture = document.getElementById('profilePicture');
                if (profilePicture) {
                    profilePicture.src = data.profilePicture ?
                        `data:image/png;base64,${data.profilePicture}` :
                        'default-profile.jpg'; // Fallback image
                } else {
                    console.error('Profile picture element not found');
                }

            })
            .catch(error => {
                console.error('Error fetching profile:', error);
                alert('An error occurred while fetching the profile.');
            });

        // Handle profile picture preview on file input change
        document.getElementById('profilePictureInput').addEventListener('change', function (event) {
            const profilePicture = document.getElementById('profilePicture');

            if (!profilePicture) {
                console.error('Profile picture element not found');
                return;
            }

            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    profilePicture.src = e.target.result; // Preview the selected image
                };
                reader.readAsDataURL(file); // Read the file
            } else {
                profilePicture.src = 'default-profile.jpg'; // Reset to default if no file is selected
            }
        });

        // Form submission handler
        document.getElementById('updateProfileForm').addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent default form submission behavior
            console.log('Form submission prevented');

            const formData = new FormData(this);
            formData.append('email', email); // Append email to the form data

            // Append the profile picture file to the FormData
            const profilePictureInput = document.getElementById('profilePictureInput');
            if (profilePictureInput && profilePictureInput.files[0]) {
                formData.append('file', profilePictureInput.files[0]); // Add the profile picture file
            }

            console.log('FormData to be sent:');
            for (const [key, value] of formData.entries()) {
                console.log(`${key}:`, value);
            }


            fetch('/api/jobseekers/profile/update', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    console.log('Raw response:', response);
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.statusText);
                    }
                    return response.text(); // Get the response as text
                })
                .then(data => {
                    console.log('Response data:', data);
                    if (data.includes('Profile updated successfully')) {
                        alert('Profile Updated Successfully!');
                        window.location.href = '/SeekerProfileNew.html'; // Redirect to profile page
                    } else {
                        alert('Profile Update Failed: ' + data);
                    }
                })
                .catch(error => {
                    console.error('Error updating profile:', error);
                    alert('An error occurred while updating the profile.');
                });
        });
    });

</script>


</body>
</html>